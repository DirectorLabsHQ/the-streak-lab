<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Streak Lab | NBA Prop Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .heat-high { background-color: #ef4444; color: white; border: 1px solid #7f1d1d; } 
        .heat-med { background-color: #f97316; color: white; border: 1px solid #7c2d12; } 
        .heat-low { background-color: #334155; color: #94a3b8; border: 1px solid #1e293b; }
        .tab-active { border-bottom: 4px solid #f97316; color: #f97316; }
        .star-active { color: #f97316; fill: #f97316; }
        .legend-badge { background: linear-gradient(45deg, #ffd700, #b8860b); color: black; font-weight: 900; }
        .team-badge { background-color: #1e293b; color: #64748b; border: 1px solid #334155; font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: 800; }
        .transition-all { transition: all 0.2s ease-in-out; }
        /* Smooth transition for table rows */
        #grid-body tr { transition: opacity 0.2s ease; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans selection:bg-orange-500/30">

    <div class="max-w-6xl mx-auto py-10 px-4">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
            <div>
                <h1 class="text-5xl font-black italic tracking-tighter text-white uppercase text-center md:text-left">THE STREAK <span class="text-orange-500 font-bold">LAB</span></h1>
                <p class="text-slate-400 mt-1 uppercase tracking-widest text-[10px] font-bold italic text-center md:text-left">Prop Intelligence for the Sharp Bettor</p>
            </div>
            <div id="last-update" class="text-[10px] font-mono text-slate-500 bg-slate-800/50 px-3 py-1 rounded border border-slate-700 uppercase tracking-widest font-bold self-center md:self-end"></div>
        </header>

        <div class="mb-6 p-3 bg-slate-800/30 border-l-4 border-orange-500 rounded-r text-[11px] text-slate-400 text-center md:text-left">
            <span class="text-white font-bold uppercase tracking-tighter mr-2">Lab Note:</span> 
            L10 Hit Rate = % of last 10 games exceeding the line. Search by Name or Team (GSW, LAL...).
        </div>

        <div class="mb-8 flex flex-col md:flex-row gap-4 items-center justify-between bg-slate-800/50 p-4 rounded-xl border border-slate-700">
            <div class="relative w-full md:w-96">
                <input type="text" id="player-search" onkeyup="filterData()" placeholder="Search Athlete or Team (GSW, LAL...)" 
                       class="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 px-4 text-sm focus:outline-none focus:border-orange-500 transition-colors">
            </div>
            
            <div class="flex items-center gap-4 md:gap-6">
                <label class="flex items-center cursor-pointer group">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500 group-hover:text-orange-500 mr-3 transition-colors">Sharp Only (70%+)</span>
                    <input type="checkbox" id="sharp-toggle" onchange="filterData()" class="w-4 h-4 accent-orange-500 rounded border-slate-700 bg-slate-900 focus:ring-0">
                </label>
                <button onclick="toggleFavoritesOnly()" id="fav-filter-btn" class="text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-orange-500 transition-all font-bold">
                    ⭐ Favorites Only
                </button>
            </div>
        </div>

        <div class="flex gap-6 mb-8 text-xs font-black uppercase tracking-tighter overflow-x-auto border-b border-slate-800 scrollbar-hide">
            <button onclick="updateView('pts_heat')" id="tab-pts_heat" class="pb-2 px-2 tab-active transition-all whitespace-nowrap">Points</button>
            <button onclick="updateView('reb_heat')" id="tab-reb_heat" class="pb-2 px-2 text-slate-500 hover:text-white transition-all whitespace-nowrap">Rebounds</button>
            <button onclick="updateView('ast_heat')" id="tab-ast_heat" class="pb-2 px-2 text-slate-500 hover:text-white transition-all whitespace-nowrap">Assists</button>
            <button onclick="updateView('tpm_heat')" id="tab-tpm_heat" class="pb-2 px-2 text-slate-500 hover:text-white transition-all whitespace-nowrap">3PM</button>
            <button onclick="updateView('ft_heat')" id="tab-ft_heat" class="pb-2 px-2 text-slate-500 hover:text-white transition-all whitespace-nowrap">Free Throws</button>
        </div>

        <div class="bg-slate-800 rounded-xl shadow-2xl overflow-hidden border border-slate-700/50">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-900/80 text-slate-500 uppercase text-[10px] font-black tracking-widest">
                        <tr>
                            <th class="px-6 py-4 w-12 text-center">Fav</th>
                            <th class="px-6 py-4">Player / Team</th>
                            <th class="px-6 py-4 text-center">L10 Hit Rate</th>
                            <th class="px-6 py-4">Last Game Summary</th>
                            <th class="px-6 py-4 text-right italic">Consistency</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body" class="divide-y divide-slate-700/30 text-sm">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let playerData = [];
        let favorites = JSON.parse(localStorage.getItem('streakLabFavs')) || [];
        let currentMetric = 'pts_heat';
        let showFavsOnly = false;

        // Legends list for auto-badging
        const legends = ["Stephen Curry", "LeBron James", "Kevin Durant", "Giannis Antetokounmpo", "Nikola Jokic", "Luka Doncic"];

        function getGrade(score) {
            if (score >= 90) return { label: 'A+', color: 'bg-emerald-500' };
            if (score >= 80) return { label: 'A', color: 'bg-green-500' };
            if (score >= 70) return { label: 'B+', color: 'bg-blue-500' };
            if (score >= 60) return { label: 'B', color: 'bg-indigo-500' };
            return { label: 'C', color: 'bg-slate-600' };
        }

        async function loadData() {
            try {
                const response = await fetch('streak_data.json');
                const json = await response.json();
                playerData = json.players;
                document.getElementById('last-update').innerText = `LIVE REFRESH: ${json.last_updated}`;
                filterData();
            } catch (e) { 
                console.error("Data Load Error", e);
                document.getElementById('grid-body').innerHTML = `<tr><td colspan="5" class="p-10 text-center text-red-400 font-bold tracking-widest uppercase">Error Loading Live Data</td></tr>`;
            }
        }

        function toggleFav(playerName) {
            if (favorites.includes(playerName)) {
                favorites = favorites.filter(f => f !== playerName);
            } else {
                favorites.push(playerName);
            }
            localStorage.setItem('streakLabFavs', JSON.stringify(favorites));
            filterData();
        }

        function toggleFavoritesOnly() {
            showFavsOnly = !showFavsOnly;
            const btn = document.getElementById('fav-filter-btn');
            
            // Toggle UI state for the button
            btn.classList.toggle('text-orange-500', showFavsOnly);
            btn.classList.toggle('bg-slate-700', showFavsOnly);
            btn.classList.toggle('px-4', showFavsOnly);
            btn.classList.toggle('py-1', showFavsOnly);
            btn.classList.toggle('rounded-full', showFavsOnly);
            
            filterData();
        }

        function updateView(metric) {
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active', 'text-white');
                btn.classList.add('text-slate-500');
            });
            document.getElementById(`tab-${metric}`).classList.add('tab-active', 'text-white');
            currentMetric = metric;
            filterData();
        }

        function filterData() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const sharpOnly = document.getElementById('sharp-toggle').checked;
            
            const filtered = playerData.filter(p => {
                // Multi-intent search (Name or Team)
                const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                const matchesSharp = sharpOnly ? Number(p[currentMetric]) >= 70 : true;
                const matchesFav = showFavsOnly ? favorites.includes(p.name) : true;
                
                return matchesSearch && matchesSharp && matchesFav;
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const body = document.getElementById('grid-body');
            const sorted = [...data].sort((a, b) => Number(b[currentMetric]) - Number(a[currentMetric]));
            
            if (sorted.length === 0) {
                body.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-20 text-center text-slate-500 text-sm italic uppercase tracking-widest font-bold">
                            No athletes or teams match your current selection.
                        </td>
                    </tr>
                `;
                return;
            }

            body.innerHTML = sorted.map(p => {
                const score = Number(p[currentMetric]);
                const grade = getGrade(score);
                const isFav = favorites.includes(p.name);
                
                // DATA CLEANING: Extract Name vs Team from "First Last TEAM"
                const tokens = p.name.split(' ');
                const teamAbbr = tokens.pop(); // Always grabs the last word as the team
                const fullName = tokens.join(' '); // Re-joins everything else as the name
                
                // Deterministic Legend check
                const isLegend = legends.some(l => fullName.startsWith(l));
                
                let heatStyle = 'heat-low';
                if (score >= 80) heatStyle = 'heat-high';
                else if (score >= 65) heatStyle = 'heat-med';

                return `
                    <tr class="hover:bg-slate-700/30 transition-all border-b border-slate-700/30">
                        <td class="px-6 py-4 text-center cursor-pointer group" onclick="toggleFav('${p.name}')">
                            <span class="${isFav ? 'star-active' : 'text-slate-700 group-hover:text-slate-500'} text-lg transition-colors">★</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-white uppercase tracking-tight">${fullName}</span>
                                    <span class="team-badge">${teamAbbr}</span>
                                </div>
                                ${isLegend ? '<div><span class="legend-badge text-[8px] px-1.5 py-0.5 rounded shadow-sm">LEGEND</span></div>' : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <span class="px-3 py-1 rounded font-mono font-black text-white w-16 ${heatStyle}">
                                    ${score}%
                                </span>
                                <span class="${grade.color} text-[10px] font-black px-2 py-0.5 rounded text-white shadow-sm w-8 text-center uppercase">
                                    ${grade.label}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-slate-400 font-mono text-[11px] uppercase italic tracking-tighter">
                            ${p.last_game}
                        </td>
                        <td class="px-6 py-4 text-right font-mono text-[10px] text-slate-600 uppercase">
                            ${p.consistency}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        loadData();
    </script>
</body>
</html>
