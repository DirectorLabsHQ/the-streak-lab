<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streak Lab | Master Intelligence</title>
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --accent: #38bdf8; --hot: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .timestamp { font-size: 0.8rem; color: var(--accent); }

        /* Search Bar & Tabs */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        #searchBar { flex-grow: 1; min-width: 300px; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: var(--card-bg); color: white; }
        
        .tabs { display: flex; gap: 5px; background: #334155; padding: 5px; border-radius: 10px; }
        .tab-btn { padding: 8px 15px; border: none; background: transparent; color: #94a3b8; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 0.8rem; }
        .tab-btn.active { background: var(--accent); color: var(--bg); }

        /* Table */
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #1e293b; color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; }
        
        .heat-pill { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; display: inline-block; width: 40px; text-align: center; }
        .gsw-row { border-left: 4px solid #fde047; }
        .active-sort { color: var(--accent) !important; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0">ðŸ”¥ Streak Lab</h1>
            <div id="update-time" class="timestamp">Updating...</div>
        </div>
        <div id="methodology" style="font-size:0.75rem; opacity:0.6; text-align:right"></div>
    </div>

    <div class="controls">
        <input type="text" id="searchBar" placeholder="Search player or team (LAL, GSW)..." onkeyup="filterAndRender()">
        <div class="tabs">
            <span style="align-self:center; font-size:0.7rem; padding:0 10px; color:#94a3b8">SORT BY:</span>
            <button class="tab-btn active" onclick="setSort('pts_heat', this)">PTS</button>
            <button class="tab-btn" onclick="setSort('reb_heat', this)">REB</button>
            <button class="tab-btn" onclick="setSort('ast_heat', this)">AST</button>
            <button class="tab-btn" onclick="setSort('tpm_heat', this)">3PM</button>
        </div>
    </div>

    <table id="labTable">
        <thead>
            <tr>
                <th>Athlete</th>
                <th>Team</th>
                <th>PTS</th>
                <th>REB</th>
                <th>AST</th>
                <th>3PM</th>
                <th>Last Outing</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let rawPlayers = [];
    let currentSort = 'pts_heat';

    async function init() {
        const res = await fetch('streak_data.json');
        const data = await res.json();
        rawPlayers = data.players;
        document.getElementById('update-time').innerText = `Last Sync: ${data.last_updated}`;
        document.getElementById('methodology').innerText = data.lab_notes.benchmarks;
        filterAndRender();
    }

    function setSort(key, btn) {
        currentSort = key;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterAndRender();
    }

    function filterAndRender() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        
        // 1. Filter + Defensive check on team_code
        let filtered = rawPlayers.filter(p => 
            p.name.toLowerCase().includes(query) || 
            (p.team_code?.toLowerCase() || "").includes(query)
        );

        // 2. Sort + Defensive check for missing fields
        filtered.sort((a, b) => (b[currentSort] || 0) - (a[currentSort] || 0));

        const body = document.getElementById('tableBody');
        body.innerHTML = filtered.map(p => `
            <tr class="${p.team_code === 'GSW' ? 'gsw-row' : ''}">
                <td><strong>${p.name}</strong></td>
                <td><span style="opacity:0.5">${p.team_code || '---'}</span></td>
                <td>${renderPill(p.pts_heat, 'pts_heat')}</td>
                <td>${renderPill(p.reb_heat, 'reb_heat')}</td>
                <td>${renderPill(p.ast_heat, 'ast_heat')}</td>
                <td>${renderPill(p.tpm_heat, 'tpm_heat')}</td>
                <td style="color:#64748b; font-size:0.8rem">${p.last_game}</td>
            </tr>
        `).join('');
    }

    function renderPill(val, key) {
        const color = val >= 80 ? '#ef4444' : (val >= 50 ? '#f97316' : '#475569');
        const isBold = key === currentSort ? 'border: 1px solid white;' : '';
        return `<span class="heat-pill" style="background:${color}; ${isBold}">${val}%</span>`;
    }

    init();
</script>
</body>
</html>
